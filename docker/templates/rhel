{% extends "base" %}

{%- block description %}{% endblock description -%}

{% block copy %}
COPY Makefile /root/Makefile
{% endblock copy %}

{%- block baserepos %}
RUN rpm -e subscription-manager


####### Install missing dependencies from centos{{ major }} ########
RUN yum-config-manager --add-repo http://centos.s.uw.edu/centos/{{ major }}/os/x86_64/
RUN yum-config-manager --add-repo http://centos.s.uw.edu/centos/{{ major }}/updates/x86_64/
RUN yum-config-manager --add-repo http://centos.s.uw.edu/centos/{{ major }}/extras/x86_64/
RUN rpm --import http://centos.s.uw.edu/centos/{{ major }}/os/x86_64/RPM-GPG-KEY-CentOS-{{ major }}
{% endblock baserepos -%}

{%- block testpackages %}
RUN yum-config-manager --add-repo http://download.opensuse.org/repositories/systemsmanagement:/saltstack:/testing:/testpackages/RHEL_{{ major }}/
RUN rpm --import http://download.opensuse.org/repositories/systemsmanagement:/saltstack:/testing:/testpackages/RHEL_{{ major }}/repodata/repomd.xml.key
{% endblock testpackages %}

{%- block salt %}
RUN yum-config-manager --add-repo http://download.opensuse.org/repositories/systemsmanagement:/saltstack:/products/RHEL_{{ major }}
RUN rpm --import http://download.opensuse.org/repositories/systemsmanagement:/saltstack:/products/RHEL_{{ major }}//repodata/repomd.xml.key
{% endblock salt %}

{%- block install %}
RUN yum -y --nogpgcheck install which make rpm-build quilt python-pip tar iproute bind-utils net-tools
RUN yum -y --nogpgcheck install python-devel python-sphinx test-package
RUN yum -y --nogpgcheck install salt-master salt-minion salt-proxy
RUN yum -y --nogpgcheck install python-salt-testing python-pytest openssh-clients openssh-server python-apache-libcloud
{% endblock install %}

{%- block entrypoint %}
ENTRYPOINT ["make", "-f", "/root/Makefile", "-C", "/salt-toaster"]
CMD ["default"]
{% endblock entrypoint %}
